# Require the proxy and fastcgi modules
server.modules += ("mod_proxy")
server.modules += ("mod_fastcgi")


# Use Flask application only for PUT or DELETE requests
$HTTP["request-method"] =~ "^(PUT|DELETE|HEAD)$" {
        proxy.server = ( "" => (( "host" => "127.0.0.1", "port" => "9002", "check-local" => "disable" )) )
}
$HTTP["url"] == "/" {
	proxy.server = ( "" => (( "host" => "127.0.0.1", "port" => "9002", "check-local" => "disable" )) )
}


# GET and POST go straight to iipsrv - enable separate IIP and IIIF endpoints
fastcgi.server = (

  "/fcgi-bin/iipsrv.fcgi" => (
      ( "host" => "127.0.0.1",
	"port" => 9001,
        "check-local" => "disable",
        "min-procs" => 1,
        "max-procs" => 1,
        "bin-path" => "/usr/local/sbin/iipsrv",
        "bin-environment" => (
		"LOGFILE" => "/tmp/iipsrv.iip.log",
		"VERBOSITY" => "1",
		"MAX_IMAGE_CACHE_SIZE" => "100",
		"FILESYSTEM_PREFIX" => "/home/tiff/",
		"FILESYSTEM_SUFFIX" => ".tif",
		"JPEG_QUALITY" => "90",
		"WEBP_QUALITY" => "75",
		"MAX_CVT" => "8000",
		"CODEC_PASSTHROUGH" => "1",
		"CORS" => "*"
        )
      )
  ),

  "/" => (
      ( "host" => "127.0.0.1",
	"port" => 9000,
        "check-local" => "disable",
        "min-procs" => 1,
        "max-procs" => 1,
        "bin-path" => "/usr/local/sbin/iipsrv",
        "bin-environment" => (
		"LOGFILE" => "/tmp/iipsrv.iiif.log",
		"VERBOSITY" => "1",
		"MAX_IMAGE_CACHE_SIZE" => "100",
		"FILESYSTEM_PREFIX" => "/home/tiff/",
		"FILESYSTEM_SUFFIX" => ".tif",
		"JPEG_QUALITY" => "90",
		"WEBP_QUALITY" => "75",
		"MAX_CVT" => "8000",
		"CODEC_PASSTHROUGH" => "1",
		"CORS" => "*",
		"URI_MAP" => "=>IIIF",
		"IIIF_EXTENSIONS" => "1"
        )
      )
  )

)
